<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrenaX Ultimate API Playground</title>

    <!-- Libraries -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.2s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        pre code.hljs {
            background: transparent;
            padding: 0;
        }

        /* Markdown Styles */
        .prose h1 {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 0.5em;
            color: #e2e8f0;
        }

        .prose h2 {
            font-size: 1.25em;
            font-weight: 600;
            margin-bottom: 0.5em;
            margin-top: 1em;
            color: #e2e8f0;
        }

        .prose p {
            margin-bottom: 0.75em;
            line-height: 1.6;
            color: #cbd5e1;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
            color: #cbd5e1;
        }

        .prose ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.75em;
            color: #cbd5e1;
        }

        .prose code {
            background: #1e293b;
            padding: 0.2em 0.4em;
            border-radius: 0.25em;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: #93c5fd;
        }

        .prose pre {
            background: #0f172a;
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
            margin-bottom: 1em;
            border: 1px solid #1e293b;
        }

        .prose pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        .prose blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1em;
            color: #94a3b8;
            font-style: italic;
        }

        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
        }

        .prose th,
        .prose td {
            border: 1px solid #334155;
            padding: 0.5em;
            text-align: left;
        }

        .prose th {
            background: #1e293b;
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-200 h-screen overflow-hidden">
    <div id="app" class="h-full flex flex-col">

        <!-- Header -->
        <header
            class="h-14 border-b border-slate-800 bg-slate-900/80 backdrop-blur flex items-center justify-between px-6 shrink-0 z-50">
            <div class="flex items-center gap-3">
                <div
                    class="w-8 h-8 rounded bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center font-bold text-white shadow-lg shadow-blue-900/20">
                    O</div>
                <h1 class="font-bold text-lg tracking-tight">OrenaX <span
                        class="text-slate-500 font-normal">Playground</span></h1>
                <span
                    class="px-2 py-0.5 rounded text-[10px] font-mono bg-slate-800 text-slate-400 border border-slate-700">{{
                    baseUrl }}</span>
            </div>

            <div class="flex items-center gap-4">
                <!-- Health Status -->
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900 border border-slate-800 text-xs transition-colors"
                    :class="healthStatus === 'ok' ? 'border-green-900/50 bg-green-900/10' : 'border-red-900/50 bg-red-900/10'">
                    <div class="w-2 h-2 rounded-full animate-pulse"
                        :class="healthStatus === 'ok' ? 'bg-green-500' : 'bg-red-500'"></div>
                    <span :class="healthStatus === 'ok' ? 'text-green-400' : 'text-red-400'">{{ healthStatus === 'ok' ?
                        'System Online' : 'System Offline' }}</span>
                </div>

                <!-- User Profile -->
                <div v-if="user" class="flex items-center gap-3 pl-4 border-l border-slate-800">
                    <div class="text-right hidden sm:block">
                        <div class="text-xs font-medium text-white">{{ user.fullName || 'User' }}</div>
                        <div class="text-[10px] text-slate-500">{{ user.email }}</div>
                    </div>
                    <button @click="logout"
                        class="p-2 rounded-lg hover:bg-red-500/10 text-slate-400 hover:text-red-400 transition-colors"
                        title="Logout">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                            </path>
                        </svg>
                    </button>
                </div>
                <div v-else>
                    <button @click="activeTab = 'auth'"
                        class="text-xs font-medium bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition-colors shadow-lg shadow-blue-900/20">
                        Login / Register
                    </button>
                </div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0 overflow-y-auto">
                <div class="p-4 space-y-6">

                    <!-- Auth Section -->
                    <div v-if="!user">
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 px-2">Authentication
                        </div>
                        <button @click="activeTab = 'auth'"
                            :class="{'bg-blue-600/10 text-blue-400 border-blue-500/20': activeTab === 'auth'}"
                            class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition-all border border-transparent">
                            üîê Login & Register
                        </button>
                    </div>

                    <!-- Gemini Section -->
                    <div>
                        <div
                            class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 px-2 flex justify-between items-center">
                            <span>Gemini API v2</span>
                            <span class="text-[10px] bg-blue-500/20 text-blue-400 px-1.5 rounded">New</span>
                        </div>
                        <div class="space-y-1">
                            <button v-for="item in menu.gemini" :key="item.id" @click="activeTab = item.id"
                                :class="{'bg-blue-600/10 text-blue-400 border-blue-500/20': activeTab === item.id}"
                                class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition-all border border-transparent flex items-center gap-2">
                                <span>{{ item.icon }}</span> {{ item.label }}
                            </button>
                        </div>
                    </div>

                    <!-- Vertex AI Section -->
                    <div>
                        <div
                            class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 px-2 flex justify-between items-center">
                            <span>Vertex AI Image</span>
                            <span v-if="!user" class="text-[10px] bg-slate-800 text-slate-500 px-1.5 rounded">Auth
                                Req</span>
                        </div>
                        <div class="space-y-1" :class="{'opacity-50 pointer-events-none': !user}">
                            <button v-for="item in menu.vertex" :key="item.id" @click="activeTab = item.id"
                                :class="{'bg-purple-600/10 text-purple-400 border-purple-500/20': activeTab === item.id}"
                                class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white transition-all border border-transparent flex items-center gap-2">
                                <span>{{ item.icon }}</span> {{ item.label }}
                            </button>
                        </div>
                    </div>

                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-y-auto bg-slate-950 relative">

                <!-- Auth View -->
                <div v-if="activeTab === 'auth'" class="max-w-md mx-auto mt-20 px-6">
                    <div class="glass rounded-2xl p-8 shadow-2xl">
                        <h2 class="text-2xl font-bold mb-6 text-center">{{ authMode === 'login' ? 'Welcome Back' :
                            'Create Account' }}</h2>

                        <div class="space-y-4">
                            <div v-if="authMode === 'register'">
                                <label class="block text-xs font-medium text-slate-400 mb-1">Full Name</label>
                                <input v-model="authForm.fullName" type="text"
                                    class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1">Email Address</label>
                                <input v-model="authForm.email" type="email"
                                    class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1">Password</label>
                                <input v-model="authForm.password" type="password"
                                    class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>

                            <button @click="handleAuth" :disabled="isLoading"
                                class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-2.5 rounded-lg transition-all flex justify-center items-center gap-2 mt-2">
                                <span v-if="isLoading" class="animate-spin">‚åõ</span>
                                {{ authMode === 'login' ? 'Sign In' : 'Sign Up' }}
                            </button>

                            <div class="text-center text-sm text-slate-500 mt-4">
                                {{ authMode === 'login' ? "Don't have an account?" : "Already have an account?" }}
                                <button @click="authMode = authMode === 'login' ? 'register' : 'login'"
                                    class="text-blue-400 hover:text-blue-300 font-medium ml-1">
                                    {{ authMode === 'login' ? 'Sign Up' : 'Sign In' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Views -->
                <div v-else class="p-6 max-w-5xl mx-auto">

                    <!-- Header for current view -->
                    <div class="mb-8 flex items-end justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                                {{ getCurrentViewTitle() }}
                            </h2>
                            <p class="text-slate-400 text-sm mt-1">{{ getCurrentViewDesc() }}</p>
                        </div>
                        <!-- Model Selector for Gemini Views -->
                        <div v-if="activeTab.startsWith('gemini')" class="flex items-center gap-2">
                            <span class="text-xs text-slate-500">Model:</span>
                            <select v-model="selectedModel"
                                class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-1.5 text-xs focus:ring-2 focus:ring-blue-500 outline-none min-w-[200px]">
                                <option v-for="m in models" :key="m.name" :value="m.name">
                                    {{ m.displayName }} {{ m.supportsThinking ? '(Thinking)' : '' }}
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- Content Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(100vh-200px)]">

                        <!-- Left: Input / Config -->
                        <div class="flex flex-col gap-4 overflow-y-auto pr-2">

                            <!-- Chat Interface -->
                            <div v-if="activeTab === 'gemini-chat'" class="flex-1 flex flex-col gap-4">
                                <div
                                    class="glass rounded-xl p-4 flex-1 overflow-y-auto space-y-4 min-h-[300px] max-h-[500px]">
                                    <div v-if="chatHistory.length === 0" class="text-center text-slate-500 py-10">
                                        Start a conversation...
                                    </div>
                                    <div v-for="(msg, idx) in chatHistory" :key="idx" class="flex flex-col gap-1"
                                        :class="msg.role === 'user' ? 'items-end' : 'items-start'">
                                        <div class="text-[10px] uppercase font-bold text-slate-500">{{ msg.role }}</div>
                                        <div class="px-4 py-2 rounded-2xl max-w-[90%] text-sm"
                                            :class="msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-sm' : 'bg-slate-800 text-slate-200 rounded-tl-sm'">
                                            <div v-if="msg.thoughts"
                                                class="mb-2 p-2 bg-black/20 rounded text-xs font-mono text-amber-200/80 border-l-2 border-amber-500/50 whitespace-pre-wrap">
                                                <div class="font-bold text-amber-500 mb-1 flex items-center gap-1">üß†
                                                    THOUGHTS</div>
                                                {{ msg.thoughts }}
                                            </div>
                                            <div class="prose prose-invert prose-sm max-w-none"
                                                v-html="renderMarkdown(msg.content)"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="glass rounded-xl p-4 space-y-3">
                                    <textarea v-model="chatInput" @keydown.ctrl.enter="sendChat" rows="3"
                                        placeholder="Type your message (Ctrl+Enter to send)..."
                                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none font-mono"></textarea>

                                    <div class="flex flex-wrap gap-4 items-center justify-between">
                                        <div class="flex gap-4">
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input v-model="config.stream" type="checkbox"
                                                    class="rounded bg-slate-800 border-slate-700 text-blue-600">
                                                <span class="text-xs text-slate-400">Stream</span>
                                            </label>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input v-model="config.thinking" type="checkbox"
                                                    class="rounded bg-slate-800 border-slate-700 text-blue-600">
                                                <span class="text-xs text-slate-400">Thinking</span>
                                            </label>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input v-model="config.googleSearch" type="checkbox"
                                                    class="rounded bg-slate-800 border-slate-700 text-blue-600">
                                                <span class="text-xs text-slate-400">Google Search</span>
                                            </label>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input v-model="config.codeExecution" type="checkbox"
                                                    class="rounded bg-slate-800 border-slate-700 text-blue-600">
                                                <span class="text-xs text-slate-400">Code Exec</span>
                                            </label>
                                        </div>
                                        <button @click="sendChat" :disabled="isLoading || !chatInput.trim()"
                                            class="bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors">
                                            {{ isLoading ? 'Sending...' : 'Send' }}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Simple Prompt Interface -->
                            <div v-if="activeTab === 'gemini-simple'" class="space-y-4">
                                <div class="glass rounded-xl p-6 space-y-4">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-400 mb-2">Prompt</label>
                                        <textarea v-model="simplePrompt" rows="6"
                                            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-mono"></textarea>
                                    </div>
                                    <button @click="sendSimple" :disabled="isLoading"
                                        class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2.5 rounded-lg font-medium transition-colors">
                                        Generate
                                    </button>
                                </div>
                            </div>

                            <!-- Image Gen Interface -->
                            <div v-if="activeTab === 'vertex-image'" class="space-y-4">
                                <div class="glass rounded-xl p-6 space-y-4">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-400 mb-2">Prompt</label>
                                        <textarea v-model="imageForm.prompt" rows="4"
                                            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none font-mono"
                                            placeholder="A futuristic city..."></textarea>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-medium text-slate-400 mb-2">Aspect
                                                Ratio</label>
                                            <select v-model="imageForm.aspectRatio"
                                                class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm">
                                                <option value="1:1">1:1 (Square)</option>
                                                <option value="16:9">16:9 (Landscape)</option>
                                                <option value="9:16">9:16 (Portrait)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-400 mb-2">Samples</label>
                                            <select v-model="imageForm.sampleCount"
                                                class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm">
                                                <option :value="1">1 Image</option>
                                                <option :value="2">2 Images</option>
                                                <option :value="4">4 Images</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button @click="generateImage" :disabled="isLoading"
                                        class="w-full bg-purple-600 hover:bg-purple-500 text-white py-2.5 rounded-lg font-medium transition-colors">
                                        {{ isLoading ? 'Generating...' : 'Generate Image' }}
                                    </button>
                                </div>
                            </div>

                        </div>

                        <!-- Right: Output / JSON -->
                        <div class="flex flex-col gap-4 overflow-hidden">
                            <div class="glass rounded-xl flex-1 flex flex-col overflow-hidden border border-slate-800">
                                <div
                                    class="px-4 py-2 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
                                    <span class="text-xs font-bold text-slate-500 uppercase">Response / Logs</span>
                                    <button @click="logs = []"
                                        class="text-[10px] text-slate-500 hover:text-white">Clear</button>
                                </div>
                                <div class="flex-1 overflow-y-auto p-4 space-y-4 font-mono text-xs">
                                    <div v-if="logs.length === 0" class="text-slate-600 text-center mt-10">
                                        No requests yet.
                                    </div>
                                    <div v-for="(log, idx) in logs" :key="idx" class="space-y-2">
                                        <div class="flex items-center gap-2">
                                            <span class="px-1.5 py-0.5 rounded text-[10px] font-bold"
                                                :class="log.type === 'req' ? 'bg-blue-900 text-blue-300' : (log.error ? 'bg-red-900 text-red-300' : 'bg-green-900 text-green-300')">
                                                {{ log.method }}
                                            </span>
                                            <span class="text-slate-400">{{ log.url }}</span>
                                            <span class="text-slate-600 ml-auto">{{ log.time }}</span>
                                        </div>

                                        <!-- Request Body -->
                                        <div v-if="log.body"
                                            class="bg-slate-950 rounded p-2 border border-slate-800 overflow-x-auto">
                                            <span class="text-slate-500 block mb-1">// Request Payload</span>
                                            <pre><code class="language-json" v-html="highlight(log.body)"></code></pre>
                                        </div>

                                        <!-- Response Body -->
                                        <div v-if="log.response"
                                            class="bg-slate-950 rounded p-2 border border-slate-800 overflow-x-auto">
                                            <span class="text-slate-500 block mb-1">// Response ({{ log.status
                                                }})</span>

                                            <!-- Image Preview if available -->
                                            <div v-if="log.images && log.images.length > 0"
                                                class="grid grid-cols-2 gap-2 mb-2">
                                                <img v-for="(img, i) in log.images" :key="i" :src="img.url"
                                                    class="rounded border border-slate-700 w-full h-auto">
                                            </div>

                                            <pre><code class="language-json" v-html="highlight(log.response)"></code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed, watch } = Vue;

        createApp({
            setup() {
                // State
                const baseUrl = window.location.origin;
                const user = ref(null);
                const token = ref(localStorage.getItem('token'));
                const activeTab = ref('gemini-chat');
                const healthStatus = ref('checking');
                const isLoading = ref(false);
                const models = ref([]);
                const selectedModel = ref('gemini-2.0-flash');
                const logs = ref([]);

                // Forms
                const authMode = ref('login');
                const authForm = reactive({ email: '', password: '', fullName: '' });

                const chatInput = ref('');
                const chatHistory = ref([]);
                const config = reactive({
                    stream: false,
                    const url = `${baseUrl}${endpoint}`;
                    const headers = { 'Content-Type': 'application/json' };
                    if(token.value) headers['Authorization'] = `Bearer ${token.value}`;

                addLog('req', method, endpoint, body, null, 'PENDING');

                try {
                    const res = await fetch(url, {
                        method,
                        headers,
                        body: body ? JSON.stringify(body) : null
                    });

                    if (streamCallback && res.ok) {
                        const reader = res.body.getReader();
                        const decoder = new TextDecoder();
                        let fullText = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            const chunk = decoder.decode(value);
                            streamCallback(chunk);
                            fullText += chunk;
                        }

                        addLog('res', method, endpoint, body, { streamed: true, length: fullText.length }, res.status);
                        return { success: true };
                    }

                    const data = await res.json();

                    // Check for images in response
                    let images = [];
                    if (data.images) images = data.images;

                    addLog('res', method, endpoint, body, data, res.status, images);

                    if (!res.ok) throw new Error(data.message || 'Request failed');
                    return data;
                } catch (e) {
                    addLog('res', method, endpoint, body, { error: e.message }, 500);
                    throw e;
                } finally {
                    isLoading.value = false;
                }
            };

            // Actions
            const checkHealth = async () => {
                try {
                    const data = await apiCall('/api/v2/health');
                    healthStatus.value = data.status;
                } catch (e) {
                    healthStatus.value = 'error';
                }
            };

            const fetchModels = async () => {
                try {
                    const data = await apiCall('/api/v2/models');
                    models.value = data.models;
                    // Set default model if available
                    if (data.defaultModel) selectedModel.value = data.defaultModel;
                } catch (e) { }
            };

            const handleAuth = async () => {
                try {
                    const endpoint = authMode.value === 'login' ? '/auth/login' : '/auth/register';
                    const data = await apiCall(endpoint, 'POST', authForm);

                    if (data.accessToken) {
                        token.value = data.accessToken;
                        localStorage.setItem('token', data.accessToken);
                        await fetchUser();
                        activeTab.value = 'gemini-chat';
                    }
                } catch (e) {
                    alert(e.message);
                }
            };

            const fetchUser = async () => {
                if (!token.value) return;
                try {
                    user.value = await apiCall('/auth/me');
                } catch (e) {
                    logout();
                }
            };

            const logout = () => {
                token.value = null;
                user.value = null;
                localStorage.removeItem('token');
                activeTab.value = 'auth';
            };

            const sendChat = async () => {
                if (!chatInput.value.trim()) return;

                const userMsg = { role: 'user', content: chatInput.value };
                chatHistory.value.push(userMsg);
                const prompt = chatInput.value;
                chatInput.value = '';

                const payload = {
                    prompt, // For simple chat, or construct messages array for full chat
                    messages: chatHistory.value.map(m => ({ role: m.role, content: m.content })),
                    model: selectedModel.value,
                    stream: config.stream,
                    thinkingConfig: config.thinking ? { includeThoughts: true, thinkingBudget: 4096 } : undefined,
                    tools: []
                };

                if (config.googleSearch) payload.tools.push({ googleSearch: {} });
                if (config.codeExecution) payload.tools.push({ codeExecution: {} });

                // Add placeholder for AI response
                const aiMsg = reactive({ role: 'model', content: '', thoughts: '' });
                chatHistory.value.push(aiMsg);

                try {
                    if (config.stream) {
                        await apiCall('/api/v2/chat/stream', 'POST', payload, (chunk) => {
                            const lines = chunk.split('\n');
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const dataStr = line.replace('data: ', '');
                                    if (dataStr === '[DONE]') break;
                                    try {
                                        const data = JSON.parse(dataStr);
                                        if (data.text) aiMsg.content += data.text;
                                        if (data.thought) aiMsg.thoughts += data.thought;
                                    } catch (e) { }
                                }
                            }
                        });
                    } else {
                        const data = await apiCall('/api/v2/chat/generate', 'POST', payload);
                        aiMsg.content = data.text;
                        if (data.thoughts) aiMsg.thoughts = data.thoughts.join('\n');
                    }
                } catch (e) {
                    aiMsg.content = `Error: ${e.message}`;
                }
            };

            const sendSimple = async () => {
                try {
                    await apiCall('/api/v2/simple', 'POST', {
                        prompt: simplePrompt.value,
                        model: selectedModel.value
                    });
                } catch (e) { }
            };

            const generateImage = async () => {
                try {
                    await apiCall('/api/v1/image/text-to-image', 'POST', {
                        prompt: imageForm.prompt,
                        model: 'imagen-3.0-generate-001',
                        sampleCount: imageForm.sampleCount,
                        outputOptions: { mimeType: 'image/png' }
                    });
                } catch (e) { }
            };

            // Lifecycle
            onMounted(async () => {
            await checkHealth();
                    await fetchModels();
                    if(token.value) await fetchUser();
                });

        // Computed
        const getCurrentViewTitle = () => {
            const map = {
                'auth': 'Authentication',
                'gemini-chat': 'Gemini Chat',
                'gemini-simple': 'Simple Prompt',
                'vertex-image': 'Text to Image'
            };
            return map[activeTab.value] || activeTab.value;
        };

        const getCurrentViewDesc = () => {
            const map = {
                'gemini-chat': 'Full chat capabilities with Streaming, Thinking Mode, and Tools.',
                'gemini-simple': 'Basic prompt-response generation.',
                'vertex-image': 'Generate high-quality images using Imagen 3 models.'
            };
            return map[activeTab.value] || '';
        };

        return {
            baseUrl, user, activeTab, healthStatus, isLoading, models, selectedModel, logs,
            authMode, authForm, chatInput, chatHistory, config, simplePrompt, imageForm, menu,
            highlight, renderMarkdown, handleAuth, logout, sendChat, sendSimple, generateImage,
            getCurrentViewTitle, getCurrentViewDesc
        };
            }
        }).mount('#app');
    </script>
</body>

</html>